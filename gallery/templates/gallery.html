{% extends "base.html" %}
{% load static %}
{% load cloudinary %}

{% block content %}

<div class="gallery-container">
    {% for folder in get_all_folders %}
    <div class="gallery-folder" data-name="{{folder.name}}">
        <div class="gallery-preview">
            {% for image in folder_images %}
            {% if image.folder == folder.path %}
            <img class="img-src" src="{{ image.secure_url }}" alt="{{folder.name}}">
            {% endif %}
            {% endfor %}
        </div>
        <h2>{{folder.name}}</h2>
    </div>
    {% endfor %}

    {% if user.is_superuser %}
    <div class="add-folder">
        <div id="add-sign">&plus;</div>
        <h2>Add New Folder</h2>
    </div>

    <div class="folder-modal">
        <form id="folder-form" method="POST" action="{% url 'gallery' %}">
            {% csrf_token %}
            {{ folder_form}}
            <button type="submit">Create folder</button>
        </form>
    </div>

    <div>
        <form class="add-image" id="upload-form" method="POST" action="{% url 'upload_images' %}" enctype="multipart/form-data">
            {% csrf_token %}
            {{ upload_form.images }}
            {{ upload_form.folder }}
            <button type="submit">Upload</button>
        </form>
    </div>
    {% endif %}
</div>
<!-- Fullscreen Gallery Modal -->
<div class="gallery-modal">
    <button class="close">&times;</button>
    <div class="gallery-main">
        <img id="main-image" class="main-image" src="" alt="">
        <button class="prev">&#10094;</button>
        <button class="next">&#10095;</button>
    </div>
    <div class="gallery-thumbnails" id="thumbnail-row">
        {% if user.is_superuser %}
        <div id="add-image-modal">&plus;</div>
        {% endif %}
    </div>
</div>

<script src="https://product-gallery.cloudinary.com/all.js" type="text/javascript"></script>
<script>
    const yearBoxes = document.querySelectorAll(".gallery-folder");
    const modal = document.querySelector(".gallery-modal");
    const closeModal = document.querySelector(".gallery-modal .close");
    const mainImage = document.getElementById("main-image");
    const thumbnailRow = document.getElementById("thumbnail-row");
    const prevBtn = document.querySelector(".prev");
    const nextBtn = document.querySelector(".next");
    const addImage = document.querySelector("#add-image-modal");

    let currentIndex = 0;
    let currentImages = [];

    yearBoxes.forEach(box => {
        box.addEventListener("click", function () {
            const folderName = this.getAttribute("data-name");
            const images = Array.from(this.querySelectorAll("img.img-src")).map(img => img.src);

            if (images.length === 0) {
                alert("No images available in this folder.");
                return;
            }

            currentImages = images;
            currentIndex = 0;

            // Fill thumbnails
            thumbnailRow.innerHTML = "";
            if(addImage){
            thumbnailRow.appendChild(addImage)
            }
            images.forEach((src, idx) => {
                const thumb = document.createElement("img");
                thumb.src = src;
                thumb.addEventListener("click", () => {
                    currentIndex = idx;
                    updateMainImage();
                });
                thumbnailRow.appendChild(thumb);
            });

            // Show modal and first image
            modal.style.display = "flex";
            updateMainImage();
        });
    });

    function updateMainImage() {
        mainImage.src = currentImages[currentIndex];
    }

    closeModal.addEventListener("click", () => {
        modal.style.display = "none";
        mainImage.src = "";
        thumbnailRow.innerHTML = "";
    });

    modal.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
            mainImage.src = "";
            thumbnailRow.innerHTML = "";
        }
    });

    prevBtn.addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
        updateMainImage();
    });

    nextBtn.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % currentImages.length;
        updateMainImage();
    });
</script>
{% endblock %}